WITH pbp AS (
  SELECT
    stg_pbp.game_id,
    stg_pbp.play_id,
    stg_pbp.season,
    stg_pbp.nfl_week,
    stg_pbp.qtr,
    stg_pbp.down,
    stg_pbp.ydstogo,
    stg_pbp.yardline_100,
    stg_pbp.play_type,
    stg_pbp.play_desc,
    stg_pbp.posteam AS offense_team_code_raw,
    stg_pbp.defteam AS defense_team_code_raw,
    stg_pbp.passer_player_id,
    stg_pbp.rusher_player_id,
    stg_pbp.receiver_player_id,
    stg_pbp.yards_gained,
    stg_pbp.passing_yards,
    stg_pbp.rushing_yards,
    stg_pbp.receiving_yards,
    stg_pbp.yards_after_catch,
    stg_pbp.epa,
    stg_pbp.wp,
    stg_pbp.success,
    stg_pbp.touchdown,
    stg_pbp.pass_touchdown,
    stg_pbp.rush_touchdown,
    stg_pbp.return_touchdown,
    stg_pbp.interception,
    stg_pbp.fumble,
    stg_pbp.fumble_lost,
    stg_pbp.fumble_forced,
    stg_pbp.series,
    stg_pbp.drive,
    stg_pbp.series
  FROM {{ ref('stg_pbp') }} AS stg_pbp
  WHERE stg_pbp.game_id IS NOT NULL
    AND stg_pbp.play_id IS NOT NULL
),

mapped AS (
  SELECT
    pbp.game_id,
    pbp.play_id,
    pbp.season,
    pbp.nfl_week,
    pbp.qtr,
    pbp.down,
    pbp.ydstogo,
    pbp.yardline_100,
    pbp.play_type,
    pbp.play_desc,
    offense_tc.franchise_id AS offense_franchise_id,
    defense_tc.franchise_id AS defense_franchise_id,
    pbp.passer_player_id,
    pbp.rusher_player_id,
    pbp.receiver_player_id,
    pbp.yards_gained,
    pbp.passing_yards,
    pbp.rushing_yards,
    pbp.receiving_yards,
    pbp.yards_after_catch,
    pbp.epa,
    pbp.wp,
    pbp.success,
    pbp.touchdown,
    pbp.pass_touchdown,
    pbp.rush_touchdown,
    pbp.return_touchdown,
    pbp.interception,
    pbp.fumble,
    pbp.fumble_lost,
    pbp.fumble_forced,
    pbp.series,
    pbp.drive
  FROM pbp
  LEFT JOIN {{ ref('dim_team_code') }} AS offense_tc
    ON offense_tc.source_team_code = pbp.offense_team_code_raw
  LEFT JOIN {{ ref('dim_team_code') }} AS defense_tc
    ON defense_tc.source_team_code = pbp.defense_team_code_raw
)

SELECT
  mapped.game_id,
  mapped.play_id,
  mapped.season,
  mapped.nfl_week,
  mapped.qtr,
  mapped.down,
  mapped.ydstogo,
  mapped.yardline_100,
  mapped.offense_franchise_id,
  mapped.defense_franchise_id,
  mapped.play_type,
  mapped.play_desc,
  mapped.passer_player_id,
  mapped.rusher_player_id,
  mapped.receiver_player_id,
  mapped.yards_gained,
  mapped.passing_yards,
  mapped.rushing_yards,
  mapped.receiving_yards,
  mapped.yards_after_catch,
  mapped.epa,
  mapped.wp,
  mapped.success,
  mapped.touchdown,
  mapped.pass_touchdown,
  mapped.rush_touchdown,
  mapped.return_touchdown,
  mapped.interception,
  mapped.fumble,
  mapped.fumble_lost,
  mapped.fumble_forced,
  mapped.series,
  mapped.drive
FROM mapped
